<!DOCTYPE html>
<html lang="en" ng-app>
<head>
	<meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge,chrome=1" />
	<title>pc端统计页面题目展现</title>
	<script src="http://cdn.bootcss.com/jquery/1.11.0/jquery.min.js"></script>
	<script src="http://cdn.bootcss.com/knockout/3.2.0/knockout-min.js"></script>

	<style>
		*{padding: 0;margin: 0;}
		body,html{background-color:#fff;}
		.mt10{margin-top: 10px;}
		.ml20{margin-left: 20px;}
		.clearfix {zoom: 1;}
		.clearfix:after {content: "";display: block;visibility: hidden;height: 0;clear: both;}
		
		.questionDetailBox{width: 100%;margin:0 auto; max-width: 1140px;padding: 10px 0;font-family: 'Microsoft YaHei';}
		.qdItem{padding: 20px 38px;font-size: 14px;color: #333;line-height: 24px;background-color: #f9f9f9;border-top: 1px solid #ebebeb;clear:both;word-break: break-word;}
		.qdTitle{background-color: #fff;border: 0;}
		.vAlingM{vertical-align: middle;}
		.qdiHead{font-size: 16px;color: #19b200;}
		.qdiBody .qdiVideo{position: relative;width: 50px;height: 50px;border-radius: 5px;overflow: hidden;display: inline-block;vertical-align: middle;margin-right: 10px;cursor: pointer;}
		.qdiBody .qdivTxt{vertical-align: middle;display: inline-block;max-width: 80%;}
		.qdiBody .qdiVideo i{position: absolute;left: 50%;top: 50%;margin: -14px 0 0 -14px;background: url(images/vPlayer.png) center no-repeat;width: 30px;height: 30px;}
		.qdiBody .qdiVideo img{min-width: 100%;min-height: 100%;max-width: 120%;display: block;}
		.qdiBody .qdiVideo span{min-width: 100%;min-height: 100%;max-width: 120%;display: block;}
		/*视频弹出层*/
		.videoBoxLayer{display: none;position: fixed;left: 0;top: 0;width: 100%;height: 100%;overflow: hidden;}
		.videoBoxLayer .vBg{position: absolute;width: 100%;height: 100%;background-color: rgba(0,0,0,0.6);opacity: 0.6;z-index: 1;}
		.videoBoxLayer .vClose{position: absolute;right: 10px;top: 0;color:#fff;font-size: 50px;font-family: 'Verdana','arial', 'Microsoft YaHei';-webkit-transform: rotate(-45deg);transform: rotate(-45deg);padding: 10px;cursor: pointer;z-index: 1;}
		.videoBoxLayer .vPlayer{position: relative;z-index: 2;max-width: 1140px;margin: 10% auto 0;width: 100%;height: 80%;}
		.videoBoxLayer .vPlayer>*{max-width: 100%;max-height: 100%;}
	</style>
</head>
<body>
	<!--ko if:viewModel.question()[0]==undefined-->
		<div style="margin: 100px auto;font-size:18px;text-align:center;color:#777;">(╯﹏╰) &nbsp;  题目不存在或已丢失~<span data-bind="text:question()[0]"></span></div>
	<!--/ko-->

	<div class="questionDetailBox">
	<!--ko foreach:question-->
		<!-- ko template:{ name:'question-template'} -->
		<!-- /ko -->
	<!--/ko-->
	</div>


	<!-- 弹出层 -->
	<div class="videoBoxLayer" id="videoBoxLayer">
		<div class="vBg" onclick="closePlayer()"></div>
		<div class="vClose" onclick="closePlayer()">+</div>
		<div class="vPlayer"></div>
	</div>

	<!--解题视频模板-->
	<script type="text/html" id="video-template">
		<!--ko if:video_unique-->
		<div class="qdItem">
			<div class="qdiHead">视频讲解</div>
			<div class="qdiBody mt10 clearfix">
				<div class="qdiVideo" data-bind="event: { click: viewModel.openPlayer.bind($data, video_unique) }"><i></i><img data-bind="attr:{src:cover_url || 'images/pic.png'}" alt=""></div>
			</div>
		</div>
		<!--/ko-->
	</script>
	<!--选择题模板-->
	<script id="question-choice-template" type="text/html">
		<!--ko with:question-->
			<div class="qdItem qdTitle">
				<div data-bind="html:stem"></div>
				<!--ko foreach:options-->
					<div><lebal data-bind="text:optionValue[$index()]"></lebal>、<span data-bind="html:stem"></span></div>
				<!--/ko-->
			</div>
			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">解析</div>
				<div class="qdiBody" data-bind="html:solving_idea || '无'"></div>
			</div>
			<!--/ko-->
			
			<!--ko foreach:explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">答案</div>
				<div class="qdiBody">
				<!--ko foreach:answers-->
				<p>
					<span data-bind="html:optionValue[$index()]+'、'"></span>
					<span data-bind="html:$data"></span>
				</p>
				<!--/ko-->
				</div>
			</div>
			<div class="qdItem">
				<div class="qdiHead">考点</div>
				<div class="qdiBody">
				<!--ko foreach:points-->
					<p>
						<span data-bind="html:$data"></span>
					</p>
				<!--/ko-->
				</div>
			</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!--填空题模板-->
	<script id="question-filling-template" type="text/html">
		<!--ko with:question-->
			<div class="qdItem qdTitle">
				<div data-bind="html:stem"></div>
				<!--ko foreach:options-->
					<div><lebal data-bind="text:($index()+1)"></lebal>、<span data-bind="html:stem"></span></div>
				<!--/ko-->
			</div>
			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">解析</div>
				<div class="qdiBody" data-bind="html:solving_idea || '无'"></div>
			</div>
			<!--/ko-->

			<!--ko foreach:$data.explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">答案</div>
				<div class="qdiBody">
				<!--ko foreach:answers-->
				<p>
					<span data-bind="html:($index()+1)+'、'"></span>
					<span data-bind="html:$data"></span>
				</p>
				<!--/ko-->
				</div>
			</div>
			<div class="qdItem">
				<div class="qdiHead">考点</div>
				<div class="qdiBody">
				<!--ko foreach:points-->
					<p>
						<span data-bind="html:$data"></span>
					</p>
				<!--/ko-->
				</div>
			</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!--复合题模板-->
	<script id="question-cloze-template" type="text/html">
		<!--ko with:question-->
			<div class="qdItem qdTitle">
				<div data-bind="html:stem"></div>
				<!--ko foreach:options-->
					<div><lebal data-bind="text:($index()+1)"></lebal>、<span data-bind="html:stem"></span></div>
				<!--/ko-->
			</div>
					
			<!--ko foreach:explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko foreach:children-->
				<div class="qdItem" style="position:relative;">
					<div class="qdiHead" data-bind="text:optionValue2[$index()]" style="font-size:20px;position:absolute;left:20px;">解析</div>
					<div class="clearfix" style="margin-left:20px;border: 1px solid #ebebeb;box-shadow: 1px 1px 2px #eee;">
						<!-- ko template:{ name:'question-template',data:$data} -->
						<!-- /ko -->
					</div>
				</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!--子题目模板-->
	<script id="question-children-template" type="text/html">
		<!--ko if:$data-->
			<div class="qdItem qdTitle" style="padding-top:10px;padding-bottom:10px;">
				<div data-bind="html:stem"></div>
				<!--ko foreach:options-->
					<div><lebal data-bind="text:($index()+1)"></lebal>、<span data-bind="html:stem"></span></div>
				<!--/ko-->
			</div>
			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">解析</div>
				<div class="qdiBody" data-bind="html:solving_idea || '无'"></div>
			</div>
			<!--/ko-->

			<!--ko foreach:$data.explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">答案</div>
				<div class="qdiBody">
				<!--ko foreach:answers-->
				<p>
					<span data-bind="html:($index()+1)+'、'"></span>
					<span data-bind="html:$data"></span>
				</p>
				<!--/ko-->
				</div>
			</div>
			<div class="qdItem">
				<div class="qdiHead">考点</div>
				<div class="qdiBody">
				<!--ko foreach:points-->
					<p>
						<span data-bind="html:$data"></span>
					</p>
				<!--/ko-->
				</div>
			</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!--简答题模板-->
	<script id="question-shortanswer-template" type="text/html">
		<!--ko with:question-->
			<div class="qdItem qdTitle">
				<div data-bind="html:stem"></div>
			</div>

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">解析</div>
				<div class="qdiBody" data-bind="html:solving_idea || '无'"></div>
			</div>
			<!--/ko-->

			<!--ko foreach:$data.explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">答案</div>
				<div class="qdiBody">
				<!--ko foreach:answers-->
				<p>
					<span data-bind="html:$data || '无'"></span>
				</p>
				<!--/ko-->
				</div>
			</div>
			<div class="qdItem">
				<div class="qdiHead">考点</div>
				<div class="qdiBody">
				<!--ko foreach:points-->
					<p>
						<span data-bind="html:$data"></span>
					</p>
				<!--/ko-->
				</div>
			</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!--判断题模板-->
	<script id="question-checking-template" type="text/html">
		<!--ko with:question-->
			<div class="qdItem qdTitle">
				<div data-bind="html:stem"></div>
				<lebal><input class="vAlingM" type="radio" disabled /></lebal> <span>正确</span>
				<lebal class="ml20"><input class="vAlingM" type="radio" disabled /></lebal> <span>错误</span>
			</div>
			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">解析</div>
				<div class="qdiBody" data-bind="html:solving_idea || '无'"></div>
			</div>
			<!--/ko-->

			<!--ko foreach:$data.explain_videos-->
				<!-- ko template:{ name:'video-template'} -->
				<!-- /ko -->
			<!--/ko-->

			<!--ko with:ref_info-->
			<div class="qdItem">
				<div class="qdiHead">答案</div>
				<div class="qdiBody">
				<!--ko foreach:answers-->
				<p>
					<span data-bind="html:$data==undefined ? '无' : $data==1 ? '错误' : '正确' "></span>
				</p>
				<!--/ko-->
				</div>
			</div>
			<div class="qdItem">
				<div class="qdiHead">考点</div>
				<div class="qdiBody">
				<!--ko foreach:points-->
					<p>
						<span data-bind="html:$data"></span>
					</p>
				<!--/ko-->
				</div>
			</div>
			<!--/ko-->
		<!--/ko-->
	</script>
	<!-- 问题整合模板 -->
	<script id="question-template" type="text/html">
	    <!--注册组件 1：单选/多选 -->
	    <!--ko if: $data.qtype==1 || $data.qtype==2 -->
	    <div data-bind='component: { name: "question-choice",params:{ question:$data } } '></div>
	    <!-- /ko -->
	    <!-- 填空题 -->
	    <!--ko if: $data.qtype==3 -->
	    <div data-bind='component: { name: "question-filling",params:{ question:$data } } '></div>
	    <!-- /ko -->
	    <!-- 完形填空/阅读理解 -->
	    <!--ko if: $data.qtype==4 || $data.qtype==5 -->
	    <div data-bind='component: { name: "question-cloze",params:{ question:$data } } '></div>
	    <!-- /ko -->
	    <!-- 简答题/题型7 -->
	    <!--ko if: $data.qtype==6 || $data.qtype==7 -->
	    <div data-bind='component: { name: "question-shortanswer",params:{ question:$data } } '></div>
	    <!-- /ko -->
	    <!-- 判断题/题型8 -->
	    <!--ko if:$data.qtype==8 -->
	    <div data-bind='component: { name: "question-checking",params:{ question:$data } } '></div>
	    <!-- /ko -->
	</script>

	<script>
		// 字母选项
		var optionValue=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z']
		// 圆圈数字选项
		var optionValue2=['①','②','③','④','⑤','⑥','⑦','⑧','⑨','⑩','⑪','⑫','⑬','⑭','⑮','⑯','⑰','⑱','⑲','⑳']
		// ko视图模型
		var viewModel = {
			question:ko.observableArray([]),	// 题目信息
			type:ko.observable(0)				// 题型
		}
		// 打开视频 
		viewModel.openPlayer = function(id){
			var player = document.getElementById('videoBoxLayer')
			var player_info = player.getElementsByClassName('vPlayer')[0]
			player_info.innerHTML = '<embed src="http://yuntv.letv.com/bcloud.swf" allowfullscreen="true" quality="high" width="100%" height="96%" align="middle" allowscriptaccess="always" flashvars="uu=2bfc338ed7&amp;vu='+id+'&amp;auto_play=1&amp;width=820&amp;height=630" type="application/x-shockwave-flash">'
			player.style.display = 'block'
		}
		// 页面加载完成执行函数
		window.onload=function(){
		    // window.external.webLoadCompleted();
			console&&console.log&&console.log('页面加载完成，开始请求数据')

			// 启动ko
			ko.applyBindings(viewModel);
			// 获取数据
			getJson('950460940485655016','0');
		}
		
		// 注册 选择题 组件
		ko.components.register('question-choice', {
		    template: { element: 'question-choice-template' }
		});
		// 注册 填空题 组件
		ko.components.register('question-filling', {
		    template: { element: 'question-filling-template' }
		});
		// 注册 复合题（完形填空、阅读理解） 组件
		ko.components.register('question-cloze', {
		    template: { element: 'question-cloze-template' }
		});
		// 注册 简答题 组件
		ko.components.register('question-shortanswer', {
		    template: { element: 'question-shortanswer-template' }
		});
		// 注册 判断题 组件
		ko.components.register('question-checking', {
		    template: { element: 'question-checking-template' }
		});

		// 获取数据接口
		function getJson(){
			var json = arguments;
			if(!json[0] || !json[1]){	// json[0]:题目ID,json[1]:视频ID,json[2]:tokenId
				alert('题目获取失败')
				return;
			}
			var vid = json[0];
			// 调试接口：获取测试数据
			if(location.href.split('?type=')[1]){
				var vidArr = [
					'950460940485655016',	// 题型type=1
					'950460940485549812',	// 题型type=2
					'606485218040362181',	// 题型type=3
					'950460940485473305',	// 题型type=4
					'609631243413090360',	// 题型type=5
					'603281493293029603',	// 题型type=6
					'950460940485579194',
					'609631016657650521'	// 题型type=8
				]
				vid = vidArr[parseInt(location.href.split('?type=')[1])-1 || 0];
				json[1] = '5623658280358666577';
			}
			var url = "http://121.14.117.225:8069/question/GetVideoQuestionByVersions?question_ver="+vid+"&video_ver="+json[1];
			var url = "http://121.14.117.225:8069/question/GetVideoQuestionByVersions?question_ver=950460940485659081&video_ver=4779959573437966314";
			getAjax(url,function(json){
				json = $.parseJSON(json)
				if(json.errcode){
					alert(json.msg? '服务请求错误：' +json.msg : '服务请求出错了~')
					return;
				}
				// 解析数据
				var jsonData = json.data || json || [];
				// 解析正确答案
				if(jsonData[0] && jsonData[0].ref_info && jsonData[0].ref_info.answers && jsonData[0].options ){
					var results = getAnswer(jsonData[0].ref_info.answers,jsonData[0].options)
					if(results && typeof results =='object' &&results.length>0) jsonData[0].ref_info.answers = results;
				}
				viewModel.question(jsonData)

				console&&console.log&&console.log('当前获取数据：\n',jsonData)
			})
		
		}
		// 获取答案列表
		// answerIdArr:正确答案选项组，options：题目选项
		function getAnswer(answerIdArr,options){
			var arr = [];
			for (var i = 0; i < answerIdArr.length; i++) {
				for (var j = 0; j < options.length; j++) {
					if(options[j].id == answerIdArr[i]){
						options[j].index = j;
						arr.push(options[j].stem); break;
					}
				};
			}
			return arr != [] ? arr : null;
		}
		// 关闭视频 
		function closePlayer(){
			var player = document.getElementById('videoBoxLayer')
			player.style.display = 'none'
		}
		// ajax请求函数
		function getAjax(url,callback){
			if (window.XMLHttpRequest)
			{// code for IE7+, Firefox, Chrome, Opera, Safari
			  	xmlhttp=new XMLHttpRequest();
			}else{// code for IE6, IE5
			  	xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
			}			
			xmlhttp.onreadystatechange=function(){
			  	if (xmlhttp.readyState==4 && xmlhttp.status==200){
			    	typeof callback =='function' ? callback(xmlhttp.responseText) : (callback=xmlhttp.responseText);
			  	}
			}
			xmlhttp.open("GET",url,true);
			xmlhttp.send();
		}
	</script>

</body>
</html>